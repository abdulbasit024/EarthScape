{% extends "base.html" %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 2rem;">
    <h1>Welcome, {{ current_user.username }}</h1>
    <p style="color: var(--text-secondary);">Here is your climate data overview.</p>
</div>

<div class="dashboard-grid">
    <!-- Status Card -->
    <div class="card">
        <h3>User Status</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Current Role: <strong>{{ current_user.role|title
                }}</strong></p>
        <p>Access Level: <span style="color: var(--accent-primary);">Active</span></p>
    </div>

    <!-- Quick Stats (Placeholder) -->
    <div class="card">
        <h3>System Status</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Database Connectivity</p>
        <p style="color: var(--accent-primary);">Operational</p>
    </div>

    <!-- Main Chart Section -->
    <div class="card" style="grid-column: 1 / -1;">
        <h3>Global Temperature Analysis</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Historical data combined with ML-powered
            predictions.</p>
        <div class="chart-container">
            <canvas id="climateChart"></canvas>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fetch data
        fetch('{{ url_for("main.climate_data") }}')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('climateChart').getContext('2d');

                const histDates = data.historical.map(d => d.Date);
                const histTemps = data.historical.map(d => d.AverageTemperature);
                const predDates = data.predictions.map(d => d.date);
                const predTemps = data.predictions.map(d => d.predicted_temp);

                const labels = [...histDates, ...predDates];
                const histDataPadded = [...histTemps, ...Array(predDates.length).fill(null)];
                const predDataPadded = [...Array(histDates.length).fill(null), ...predTemps];

                // Global Chart Defaults
                Chart.defaults.color = '#94a3b8';
                Chart.defaults.borderColor = '#334155';
                Chart.defaults.font.family = "'Outfit', sans-serif";

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Historical Temp (°C)',
                            data: histDataPadded,
                            borderColor: '#10b981', // Emerald 500
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 0
                        }, {
                            label: 'Predicted Temp (°C)',
                            data: predDataPadded,
                            borderColor: '#ef4444', // Red 500
                            borderDash: [5, 5],
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                backgroundColor: 'rgba(30, 41, 59, 0.9)',
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: '#334155',
                                borderWidth: 1,
                                padding: 10
                            }
                        },
                        scales: {
                            y: {
                                grid: {
                                    color: '#334155'
                                },
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error("Error loading climate data:", err);
                // Ideally show an error state in the UI
            });
    });
</script>
{% endblock %}